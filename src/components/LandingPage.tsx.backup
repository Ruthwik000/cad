import { useState, useEffect } from 'react';
import { Button } from 'primereact/button';
import { InputTextarea } from 'primereact/inputtextarea';
import FlowFieldBackground from './FlowFieldBackground';
import AuthDialog from './AuthDialog';
import { useAuth } from '../contexts/AuthContext';
import { getUserSessions, Session } from '../firebase/firestore';
import { ProgressSpinner } from 'primereact/progressspinner';

interface LandingPageProps {
  onStartProject: (prompt: string) => void;
}

export default function LandingPage({ onStartProject }: LandingPageProps) {
  const [prompt, setPrompt] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [showAuthDialog, setShowAuthDialog] = useState(false);
  const [authMode, setAuthMode] = useState<'login' | 'signup'>('login');
  const { user, logOut } = useAuth();
  const [sessions, setSessions] = useState<Session[]>([]);
  const [loadingSessions, setLoadingSessions] = useState(false);

  // Load user sessions when logged in
  useEffect(() => {
    if (user) {
      loadUserSessions();
    }
  }, [user]);

  const loadUserSessions = async () => {
    if (!user) return;
    
    try {
      setLoadingSessions(true);
      const userSessions = await getUserSessions(user.uid);
      setSessions(userSessions.slice(0, 10)); // Show last 10 sessions
    } catch (error) {
      console.error('Error loading sessions:', error);
    } finally {
      setLoadingSessions(false);
    }
  };

  const handleSelectSession = (session: Session) => {
    // Load session and start project
    localStorage.setItem('currentSessionId', session.id);
    onStartProject(session.title);
  };

  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return 'Good morning!';
    if (hour < 18) return 'Good afternoon!';
    return 'Good evening!';
  };

  const examplePrompts = [
    "Create a simple cube with rounded edges",
    "Design a phone stand with 45 degree angle",
    "Make a parametric gear with 20 teeth",
    "Create a vase with spiral pattern",
    "Design a customizable box with lid"
  ];

  const handleGenerate = () => {
    if (prompt.trim()) {
      setIsGenerating(true);
      onStartProject(prompt);
    }
  };

  return (
    <div style={{
      width: '100vw',
      height: '100vh',
      position: 'relative',
      overflow: 'hidden'
    }}>
      {/* Flow Field Background */}
      <FlowFieldBackground
        color="#818cf8" // Indigo-400
        trailOpacity={0.1}
        particleCount={800}
        speed={0.8}
        style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '100%',
          zIndex: 0
        }}
      />

      {/* Transparent Header */}
      <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        zIndex: 100,
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '1.5rem 3rem',
        backgroundColor: 'rgba(0, 0, 0, 0.3)',
        backdropFilter: 'blur(10px)',
        borderBottom: '1px solid rgba(255, 255, 255, 0.1)'
      }}>
        {/* Logo */}
        <div style={{
          fontSize: '1.5rem',
          fontWeight: 700,
          color: '#ffffff',
          letterSpacing: '-0.5px'
        }}>
          Venus
        </div>

        {/* Auth Buttons */}
        <div style={{
          display: 'flex',
          gap: '1rem',
          alignItems: 'center'
        }}>
          {user ? (
            <>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '0.75rem',
                color: '#ffffff',
                fontSize: '0.9rem'
              }}>
                {user.photoURL && (
                  <img 
                    src={user.photoURL} 
                    alt="Profile" 
                    style={{
                      width: '32px',
                      height: '32px',
                      borderRadius: '50%',
                      border: '2px solid #3b82f6'
                    }}
                  />
                )}
                <span>{user.displayName || user.email}</span>
              </div>
              <Button
                label="Sign Out"
                onClick={async () => {
                  await logOut();
                }}
                style={{
                  color: '#ffffff',
                  backgroundColor: 'transparent',
                  fontSize: '0.95rem',
                  fontWeight: 500,
                  padding: '0.5rem 1.5rem',
                  border: '1px solid rgba(255, 255, 255, 0.3)',
                  borderRadius: '8px'
                }}
              />
            </>
          ) : (
            <>
              <Button
                label="Log in"
                text
                onClick={() => {
                  setAuthMode('login');
                  setShowAuthDialog(true);
                }}
                style={{
                  color: '#ffffff',
                  fontSize: '0.95rem',
                  fontWeight: 500,
                  padding: '0.5rem 1.5rem',
                  backgroundColor: 'transparent',
                  border: 'none'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                }}
              />
              <Button
                label="Get started"
                onClick={() => {
                  setAuthMode('signup');
                  setShowAuthDialog(true);
                }}
                style={{
                  color: '#000000',
                  backgroundColor: '#ffffff',
                  fontSize: '0.95rem',
                  fontWeight: 600,
                  padding: '0.5rem 1.5rem',
                  border: 'none',
                  borderRadius: '8px',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#f0f0f0';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = '#ffffff';
                }}
              />
            </>
          )}
        </div>
      </div>

      {/* Auth Dialog */}
      <AuthDialog
        visible={showAuthDialog}
        onHide={() => setShowAuthDialog(false)}
      />

      {/* Content Overlay */}
      <div style={{
        position: 'relative',
        zIndex: 1,
        width: '100%',
        minHeight: '100%',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        padding: '20px',
        paddingTop: '100px',
        overflowY: 'auto'
      }}>

      <style>
        {`
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
          }
        `}
      </style>

      {/* Show greeting and sessions if logged in, otherwise show hero */}
      {user ? (
        /* Logged In View - Show Greeting and Sessions */
        <div style={{
          maxWidth: '900px',
          width: '100%',
          zIndex: 1,
          margin: '0 auto',
          paddingTop: '4vh'
        }} className="fade-in-up">
          {/* Greeting */}
          <h1 style={{
            fontSize: '3rem',
            fontWeight: 700,
            color: '#ffffff',
            marginBottom: '3rem',
            textAlign: 'center'
          }}>
            {getGreeting()}
          </h1>

          {/* Prompt Input */}
          <div style={{
            backgroundColor: 'rgba(20, 20, 20, 0.95)',
            borderRadius: '24px',
            padding: '1.5rem',
            boxShadow: '0 20px 60px rgba(0,0,0,0.8)',
            border: '1px solid #333333',
            marginBottom: '3rem',
            backdropFilter: 'blur(10px)',
            width: '100%'
          }}>
            <InputTextarea
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder="Start building with Venus..."
              rows={3}
              autoResize
              disabled={isGenerating}
              onKeyDown={(e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                  handleGenerate();
                }
              }}
              style={{
                width: '100%',
                fontSize: '1.05rem',
                border: 'none',
                borderRadius: '16px',
                padding: '1.5rem',
                resize: 'none',
                fontFamily: 'inherit',
                backgroundColor: 'transparent',
                color: '#9ca3af',
                minHeight: '80px'
              }}
            />

            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginTop: '1rem',
              paddingTop: '1rem',
              borderTop: '1px solid #333333'
            }}>
              <div style={{
                display: 'flex',
                gap: '1rem',
                alignItems: 'center'
              }}>
                <button style={{
                  background: 'transparent',
                  border: '1px solid #333333',
                  borderRadius: '8px',
                  padding: '0.5rem 0.75rem',
                  color: '#9ca3af',
                  cursor: 'pointer',
                  fontSize: '0.9rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  <i className="pi pi-plus" style={{ fontSize: '0.8rem' }}></i>
                </button>
                <div style={{
                  fontSize: '0.85rem',
                  color: '#666666'
                }}>
                  Press Ctrl+Enter
                </div>
              </div>
              
              <Button
                label={isGenerating ? "Generating..." : "Create now"}
                icon={isGenerating ? "pi pi-spin pi-spinner" : "pi pi-arrow-right"}
                iconPos="right"
                onClick={handleGenerate}
                disabled={!prompt.trim() || isGenerating}
                style={{
                  padding: '0.75rem 2rem',
                  fontSize: '1rem',
                  fontWeight: 600,
                  background: '#3b82f6',
                  color: '#ffffff',
                  border: 'none',
                  borderRadius: '12px',
                  boxShadow: '0 4px 12px rgba(59, 130, 246, 0.4)',
                  transition: 'all 0.3s ease'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.boxShadow = '0 6px 16px rgba(59, 130, 246, 0.5)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
                }}
              />
            </div>
          </div>

          {/* Recent Sessions */}
          {loadingSessions ? (
            <div style={{ textAlign: 'center', padding: '2rem' }}>
              <ProgressSpinner style={{ width: '40px', height: '40px' }} />
            </div>
          ) : sessions.length > 0 && (
            <div style={{ marginBottom: '4rem' }}>
              <h3 style={{
                fontSize: '1.2rem',
                fontWeight: 600,
                color: '#ffffff',
                marginBottom: '1.5rem'
              }}>
                Recent Sessions
              </h3>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                gap: '1rem'
              }}>
                {sessions.map((session) => (
                  <div
                    key={session.id}
                    onClick={() => handleSelectSession(session)}
                    style={{
                      backgroundColor: 'rgba(20, 20, 20, 0.8)',
                      padding: '1.5rem',
                      borderRadius: '16px',
                      border: '1px solid #333333',
                      backdropFilter: 'blur(10px)',
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = 'rgba(30, 30, 30, 0.9)';
                      e.currentTarget.style.borderColor = '#3b82f6';
                      e.currentTarget.style.transform = 'translateY(-4px)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = 'rgba(20, 20, 20, 0.8)';
                      e.currentTarget.style.borderColor = '#333333';
                      e.currentTarget.style.transform = 'translateY(0)';
                    }}
                  >
                    <div style={{
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '0.75rem',
                      marginBottom: '0.75rem'
                    }}>
                      <i className="pi pi-comments" style={{
                        fontSize: '1.2rem',
                        color: '#3b82f6'
                      }}></i>
                      <div style={{ flex: 1 }}>
                        <div style={{
                          color: '#ffffff',
                          fontSize: '1rem',
                          fontWeight: 500,
                          marginBottom: '0.5rem',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {session.title}
                        </div>
                        <div style={{
                          color: '#666666',
                          fontSize: '0.8rem',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.5rem'
                        }}>
                          <span>{session.messages?.length || 0} messages</span>
                          <span>â€¢</span>
                          <span>{session.updatedAt.toDate().toLocaleDateString()}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      ) : (
        /* Not Logged In View - Show Hero */
        <div style={{
          maxWidth: '950px',
          width: '100%',
          zIndex: 1,
          textAlign: 'center',
          margin: '0 auto',
          paddingTop: '12vh'
        }} className="fade-in-up">
        {/* Hero Title */}
        <h1 style={{
          fontSize: '4rem',
          fontWeight: 700,
          color: '#ffffff',
          marginBottom: '1.5rem',
          lineHeight: '1.1',
          letterSpacing: '-0.02em'
        }}>
          What will you <span style={{ color: '#818cf8', fontStyle: 'italic' }}>create</span> today?
        </h1>

        <p style={{
          fontSize: '1.4rem',
          color: '#9ca3af',
          marginBottom: '4rem',
          fontWeight: 400
        }}>
          Create stunning 3D models by chatting with AI.
        </p>

        {/* Prompt input area */}
        <div style={{
          backgroundColor: 'rgba(20, 20, 20, 0.95)',
          borderRadius: '24px',
          padding: '1.5rem',
          boxShadow: '0 20px 60px rgba(0,0,0,0.8)',
          border: '1px solid #333333',
          marginBottom: '3rem',
          backdropFilter: 'blur(10px)',
          width: '100%'
        }}>
          <InputTextarea
            value={prompt}
            onChange={(e) => setPrompt(e.target.value)}
            placeholder="What do you want to build?"
            rows={6}
            autoResize
            disabled={isGenerating}
            onKeyDown={(e) => {
              if (e.key === 'Enter' && e.ctrlKey) {
                handleGenerate();
              }
            }}
            style={{
              width: '100%',
              fontSize: '1.05rem',
              border: 'none',
              borderRadius: '16px',
              padding: '1.5rem',
              resize: 'none',
              fontFamily: 'inherit',
              backgroundColor: 'transparent',
              color: '#9ca3af',
              minHeight: '120px'
            }}
          />

          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginTop: '1rem',
            paddingTop: '1rem',
            borderTop: '1px solid #333333'
          }}>
            <div style={{
              display: 'flex',
              gap: '1rem',
              alignItems: 'center'
            }}>
              <button style={{
                background: 'transparent',
                border: '1px solid #333333',
                borderRadius: '8px',
                padding: '0.5rem 0.75rem',
                color: '#9ca3af',
                cursor: 'pointer',
                fontSize: '0.9rem',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
              }}>
                <i className="pi pi-plus" style={{ fontSize: '0.8rem' }}></i>
              </button>
              <div style={{
                fontSize: '0.85rem',
                color: '#666666'
              }}>
                Press Ctrl+Enter
              </div>
            </div>
            
            <Button
              label={isGenerating ? "Generating..." : "Create now"}
              icon={isGenerating ? "pi pi-spin pi-spinner" : "pi pi-arrow-right"}
              iconPos="right"
              onClick={handleGenerate}
              disabled={!prompt.trim() || isGenerating}
              style={{
                padding: '0.75rem 2rem',
                fontSize: '1rem',
                fontWeight: 600,
                background: '#3b82f6',
                color: '#ffffff',
                border: 'none',
                borderRadius: '12px',
                boxShadow: '0 4px 12px rgba(59, 130, 246, 0.4)',
                transition: 'all 0.3s ease'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = '0 6px 16px rgba(59, 130, 246, 0.5)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
              }}
            />
          </div>
        </div>

        {/* Example prompts */}
        <div style={{
          textAlign: 'center',
          marginBottom: '8rem',
          width: '100%'
        }}>
          <p style={{
            color: '#666666',
            fontSize: '0.9rem',
            marginBottom: '1.5rem',
            fontWeight: 400
          }}>
            Try these examples:
          </p>
          <div style={{
            display: 'flex',
            flexWrap: 'wrap',
            gap: '0.75rem',
            justifyContent: 'center'
          }}>
            {examplePrompts.map((example, index) => (
              <button
                key={index}
                onClick={() => setPrompt(example)}
                disabled={isGenerating}
                style={{
                  backgroundColor: 'transparent',
                  color: '#9ca3af',
                  border: '1px solid #333333',
                  borderRadius: '20px',
                  padding: '0.6rem 1.2rem',
                  fontSize: '0.85rem',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                  e.currentTarget.style.borderColor = '#444444';
                  e.currentTarget.style.color = '#ffffff';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.borderColor = '#333333';
                  e.currentTarget.style.color = '#9ca3af';
                }}
              >
                {example}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Features Section - Only show when not logged in */}
      {!user && (
        <div style={{
          width: '100%',
          maxWidth: '1200px',
          margin: '0 auto',
          padding: '6rem 2rem',
          zIndex: 1
        }}>
        <h2 style={{
          fontSize: '2.5rem',
          fontWeight: 700,
          color: '#ffffff',
          textAlign: 'center',
          marginBottom: '1rem'
        }}>
          Powerful Features
        </h2>
        <p style={{
          fontSize: '1.1rem',
          color: '#9ca3af',
          textAlign: 'center',
          marginBottom: '4rem'
        }}>
          Everything you need to create amazing 3D models
        </p>

        {/* Features */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
          gap: '2rem',
          color: '#ffffff',
          width: '100%'
        }}>
          <div 
            className="feature-card"
            style={{
              backgroundColor: 'rgba(20, 20, 20, 0.8)',
              padding: '2.5rem',
              borderRadius: '20px',
              border: '1px solid #333333',
              backdropFilter: 'blur(10px)',
              transition: 'all 0.3s ease',
              cursor: 'pointer'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-8px)';
              e.currentTarget.style.borderColor = '#818cf8';
              e.currentTarget.style.boxShadow = '0 20px 40px rgba(129, 140, 248, 0.2)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.borderColor = '#333333';
              e.currentTarget.style.boxShadow = 'none';
            }}
          >
            <div style={{
              width: '48px',
              height: '48px',
              borderRadius: '12px',
              background: 'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              marginBottom: '1.5rem'
            }}>
              <i className="pi pi-sparkles" style={{ fontSize: '1.5rem', color: '#ffffff' }}></i>
            </div>
            <div style={{ fontWeight: 600, marginBottom: '0.75rem', color: '#ffffff', fontSize: '1.3rem' }}>
              AI-Powered Generation
            </div>
            <div style={{ fontSize: '1rem', color: '#9ca3af', lineHeight: '1.6' }}>
              Transform your ideas into detailed 3D models using advanced AI. Just describe what you want to create.
            </div>
          </div>

          <div 
            className="feature-card"
            style={{
              backgroundColor: 'rgba(20, 20, 20, 0.8)',
              padding: '2.5rem',
              borderRadius: '20px',
              border: '1px solid #333333',
              backdropFilter: 'blur(10px)',
              transition: 'all 0.3s ease',
              cursor: 'pointer'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-8px)';
              e.currentTarget.style.borderColor = '#818cf8';
              e.currentTarget.style.boxShadow = '0 20px 40px rgba(129, 140, 248, 0.2)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.borderColor = '#333333';
              e.currentTarget.style.boxShadow = 'none';
            }}
          >
            <div style={{
              width: '48px',
              height: '48px',
              borderRadius: '12px',
              background: 'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              marginBottom: '1.5rem'
            }}>
              <i className="pi pi-video" style={{ fontSize: '1.5rem', color: '#ffffff' }}></i>
            </div>
            <div style={{ fontWeight: 600, marginBottom: '0.75rem', color: '#ffffff', fontSize: '1.3rem' }}>
              Hand Gesture Control
            </div>
            <div style={{ fontSize: '1rem', color: '#9ca3af', lineHeight: '1.6' }}>
              Control your 3D viewport with intuitive hand gestures. Rotate, pan, and zoom using your webcam.
            </div>
          </div>

          <div 
            className="feature-card"
            style={{
              backgroundColor: 'rgba(20, 20, 20, 0.8)',
              padding: '2.5rem',
              borderRadius: '20px',
              border: '1px solid #333333',
              backdropFilter: 'blur(10px)',
              transition: 'all 0.3s ease',
              cursor: 'pointer'
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.transform = 'translateY(-8px)';
              e.currentTarget.style.borderColor = '#818cf8';
              e.currentTarget.style.boxShadow = '0 20px 40px rgba(129, 140, 248, 0.2)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.borderColor = '#333333';
              e.currentTarget.style.boxShadow = 'none';
            }}
          >
            <div style={{
              width: '48px',
              height: '48px',
              borderRadius: '12px',
              background: 'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              marginBottom: '1.5rem'
            }}>
              <i className="pi pi-download" style={{ fontSize: '1.5rem', color: '#ffffff' }}></i>
            </div>
            <div style={{ fontWeight: 600, marginBottom: '0.75rem', color: '#ffffff', fontSize: '1.3rem' }}>
              Export Ready
            </div>
            <div style={{ fontSize: '1rem', color: '#9ca3af', lineHeight: '1.6' }}>
              Download your models in multiple formats including STL, GLB, and 3MF for 3D printing or rendering.
            </div>
          </div>
        </div>
      </div>
      )}

      {/* Footer */}
      <div style={{
        position: 'relative',
        paddingBottom: '20px',
        color: '#666666',
        fontSize: '0.9rem',
        zIndex: 1,
        textAlign: 'center'
      }}>
        Powered by OpenSCAD & AI
      </div>
      </div>
    </div>
  );
}
